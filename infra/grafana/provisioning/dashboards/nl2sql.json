{
  "title": "NL2SQL Copilot â€” Unified Observability",
  "uid": "nl2sql-unified",
  "timezone": "browser",
  "editable": true,
  "schemaVersion": 38,
  "version": 5,
  "refresh": "30s",
  "panels": [
    {
      "id": 1,
      "type": "timeseries",
      "title": "Stage p95 Latency (s)",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "nl2sql:stage_p95_ms / 1000",
          "legendFormat": "{{stage}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green"
              },
              {
                "value": 1000,
                "color": "orange"
              },
              {
                "value": 2000,
                "color": "red"
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "x": 0,
        "y": 0,
        "w": 12,
        "h": 6
      }
    },
    {
      "id": 2,
      "type": "stat",
      "title": "Pipeline OK Ratio (%)",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "100 * (sum(increase(pipeline_runs_total{status=\"ok\"}[$__range])) / clamp_min(sum(increase(pipeline_runs_total[$__range])), 1))",
          "refId": "A"
        }
      ],
      "options": {
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ]
        },
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "center"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 1,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "red"
              },
              {
                "value": 90,
                "color": "orange"
              },
              {
                "value": 97,
                "color": "green"
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "x": 12,
        "y": 0,
        "w": 6,
        "h": 4
      }
    },
    {
      "id": 8,
      "type": "stat",
      "title": "Realtime OK Rate (%)",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "100 * (sum(rate(pipeline_runs_total{status=\"ok\"}[$__rate_interval])) / clamp_min(sum(rate(pipeline_runs_total[$__rate_interval])), 1))",
          "refId": "A"
        }
      ],
      "options": {
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ]
        },
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "center"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 1,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "red"
              },
              {
                "value": 90,
                "color": "orange"
              },
              {
                "value": 97,
                "color": "green"
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "x": 18,
        "y": 0,
        "w": 6,
        "h": 4
      },
      "description": "Uses rate() over $__rate_interval for short-term health. With low traffic it can be noisy; prefer 'Pipeline OK Ratio (%)' for selected-window aggregate."
    },
    {
      "id": 3,
      "type": "stat",
      "title": "Repair Success Rate (%)",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "100 * (sum(increase(repair_attempts_total{outcome=\"success\"}[$__range])) / clamp_min(sum(increase(repair_attempts_total{outcome=\"attempt\"}[$__range])), 1))",
          "refId": "A"
        }
      ],
      "options": {
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ]
        },
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "center"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 1,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "red"
              },
              {
                "value": 80,
                "color": "orange"
              },
              {
                "value": 95,
                "color": "green"
              }
            ]
          }
        }
      },
      "gridPos": {
        "x": 12,
        "y": 4,
        "w": 6,
        "h": 4
      }
    },
    {
      "id": 4,
      "type": "gauge",
      "title": "Cache Hit Ratio",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "100 * (nl2sql:cache_hit_ratio or vector(0))",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "min": 0,
          "max": 100,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "red"
              },
              {
                "value": 70,
                "color": "orange"
              },
              {
                "value": 90,
                "color": "green"
              }
            ]
          },
          "decimals": 1,
          "noValue": "0"
        },
        "overrides": []
      },
      "options": {
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ]
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true
      },
      "gridPos": {
        "x": 0,
        "y": 6,
        "w": 6,
        "h": 4
      }
    },
    {
      "id": 5,
      "type": "timeseries",
      "title": "Safety & Verifier Events (per min)",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "(rate(safety_blocks_total[$__rate_interval]) * 60) or vector(0)",
          "legendFormat": "safety blocks",
          "refId": "A"
        },
        {
          "expr": "(rate(verifier_failures_total[$__rate_interval]) * 60) or vector(0)",
          "legendFormat": "verifier failures",
          "refId": "B"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "min": 0,
          "decimals": 0,
          "unit": "ops"
        }
      },
      "gridPos": {
        "x": 6,
        "y": 6,
        "w": 12,
        "h": 6
      }
    },
    {
      "id": 6,
      "type": "stat",
      "title": "Requests in window",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "sum(increase(pipeline_runs_total[$__range]))",
          "refId": "A"
        }
      ],
      "options": {
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "orientation": "auto",
        "textMode": "auto",
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "none",
          "decimals": 0,
          "noValue": "0",
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "x": 12,
        "y": 8,
        "w": 6,
        "h": 2
      }
    },
    {
      "id": 7,
      "type": "stat",
      "title": "OK requests in window",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "sum(increase(pipeline_runs_total{status=\"ok\"}[$__range]))",
          "refId": "A"
        }
      ],
      "options": {
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "orientation": "auto",
        "textMode": "auto",
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "none",
          "decimals": 0,
          "noValue": "0",
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "x": 12,
        "y": 10,
        "w": 6,
        "h": 2
      }
    }
  ]
}
