services:
  nl2sql:
    build:
      context: ..
      dockerfile: Dockerfile
    image: nl2sql:dev
    container_name: nl2sql
    restart: unless-stopped
    env_file:
      - ../.env
    environment:
      API_KEY: ${API_KEY:-dev-key}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
    ports:
      - "8000:8000"
    networks:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8000/healthz"]
      interval: 10s
      timeout: 2s
      retries: 10

  prometheus:
    image: prom/prometheus:latest
    container_name: nl2sql-prom
    restart: unless-stopped
    # Use configs (not bind mounts) to avoid Docker Desktop creating host paths / dir-vs-file traps
    configs:
      - source: prom_config
        target: /etc/prometheus/prometheus.yml
      - source: prom_rules
        target: /etc/prometheus/rules.yml
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    ports:
      - "9090:9090"
    depends_on:
      - nl2sql
    networks:
      - backend

  grafana:
    image: grafana/grafana:latest
    container_name: nl2sql-grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    networks:
      - backend
    volumes:
      - ./grafana/provisioning/datasources/datasource.yml:/etc/grafana/provisioning/datasources/datasource.yml:ro
      - ./grafana/provisioning/dashboards/dashboard.yml:/etc/grafana/provisioning/dashboards/dashboard.yml:ro
      - ./grafana/provisioning/dashboards/nl2sql.json:/var/lib/grafana/dashboards/nl2sql.json:ro

  demo-traffic:
    image: curlimages/curl:8.10.1
    container_name: nl2sql-demo-traffic
    restart: unless-stopped
    profiles: ["traffic"]
    depends_on:
      nl2sql:
        condition: service_healthy
    env_file:
      - ../.env
    environment:
      API_KEY: ${API_KEY:-dev-key}
    command: >
      sh -lc '
        echo "demo-traffic: warming nl2sql metrics...";
        while true; do
          curl -fsS http://nl2sql:8000/healthz >/dev/null 2>&1 || true;
          curl -fsS -X POST http://nl2sql:8000/v1/query \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            -d "{\"question\":\"List the first 10 artists.\"}" \
            >/dev/null 2>&1 || true;
          sleep 2;
        done
      '
    networks:
      - backend

configs:
  prom_config:
    file: ./prometheus/prometheus.yml
  prom_rules:
    file: ./prometheus/rules.yml

networks:
  backend:
    driver: bridge
